<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1">


    <!-- <link rel="stylesheet" type="text/css" href="style.css" /> -->
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.8.0/css/bulma.min.css"> -->
    <script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>

    <link href="https://fonts.googleapis.com/css?family=Shrikhand&display=swap" rel="stylesheet">
    <title>
        Sports Betting</title>
    <link href="https://unpkg.com/tailwindcss@^1.0/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="accountStyle.css">
</head>

<body>

        <div class="flex bg-gray-200 w-full h-full">
            <div class="flex bg-blue-200 h-full w-2/12 text-center">
            </div>
            <div class="flex flex-col bg-blue-800 h-full w-5/6">
                <div class="flex h-20 bg-gray-600">
                </div>
                <div class="flex flex-col h-full bg-white p-6" id="cardHolder">
                    <div id="money" class="flex-col justify-center bg-blue-500 rounded-lg m-4 ">
                        <div>
                            <div class="flex flex-col justify-center p-2">
                                <div class="flex justify-center">
                                    <p id="moneyAmount" class="text-center text-4xl" id="teamNames">You Have: $<p class="text-center text-4xl" id="moneyAmount2"></p></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button id="seeBets" onclick="fillActiveBets()">Click to See Active Bets</button>
                    <div class="hidden flex-col justify-center bg-blue-500 rounded-lg m-4 " id="gameCard">
                    <div>
                            <div class="flex flex-col justify-center p-2">
                                <div class="flex justify-center">
                                    <p class="text-center text-4xl" id="teamNames">Home vs Away</p>
                                </div>
                                <div class="flex justify-center">
                                    <p class="text-center text-2xl" id="teamBetOn">Team Bet: </p>
                                </div>
                                <div class="flex justify-center">
                                    <p class="text-center text-2xl" id="OddsBetOn">Odds: </p>
                                </div>
                                <div class="flex justify-center">
                                    <p class="text-center text-2xl" id="ProfitIfWin">Profit(if win): $</p>
                                </div>
                                <div class="flex justify-center">
                                    <p class="text-center text-2xl" id="gameDate">Date:</p>
                                </div>
                            </div>
                            <div class="flex justify-around p-2">
                                <div class="flex">
                                    <input
                                        class="changeBetAmount shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                        type="number" name="quantity" min="1" id="betField" placeholder="Change bet value">
                                    <button
                                        class="changeBet bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-full">
                                        Change Bet
                                    </button>
                                    
                                </div>
                                <div class="flex">
                                    <button
                                        class="deleteBet bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-full" type = "submit">
                                        Delete Bet
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>


                    <div id="noBets" class="hidden flex-col justify-center bg-blue-500 rounded-lg m-4 ">
                        <div>
                            <div class="flex flex-col justify-center p-2">
                                <div class="flex justify-center">
                                    <p class="text-center text-4xl" id="teamNames">You Have Not Made Any Bets</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    
    
                </div>
            </div>
        </div>
    
    
        <!-- Insert these scripts at the bottom of the HTML, but before you use any Firebase services -->

        <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
        <script src="https://www.gstatic.com/firebasejs/7.5.0/firebase-app.js"></script>

        <!-- If you enabled Analytics in your project, add the Firebase SDK for Analytics -->
        <script src="https://www.gstatic.com/firebasejs/7.5.0/firebase-analytics.js"></script>

        <!-- Add Firebase products that you want to use -->
        <script src="https://www.gstatic.com/firebasejs/7.5.0/firebase-auth.js"></script>
        <script src="https://www.gstatic.com/firebasejs/7.5.0/firebase-firestore.js"></script>
    
    
        <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
        <script>
            var firebaseConfig = {
                apiKey: "AIzaSyAUCvhMARWj4SbCv3Bh1-mzo4OC31hIg3g",
                authDomain: "sportsbetting-61b8e.firebaseapp.com",
                databaseURL: "https://sportsbetting-61b8e.firebaseio.com",
                projectId: "sportsbetting-61b8e",
                storageBucket: "sportsbetting-61b8e.appspot.com",
                messagingSenderId: "688706831427",
                appId: "1:688706831427:web:1a7c0b4f2ae2a8aea640f6",
                measurementId: "G-QZQS0PGRJD"
            };

            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);
            var db = firebase.firestore();

            var provider = new firebase.auth.GoogleAuthProvider();
            function sign_in() {
                firebase.auth().signInWithRedirect(provider);
            }

            firebase.auth().onAuthStateChanged(function(user) {
                if (user) {
                    console.log("user is signed in ");
                } else {
                    console.log("no user is signed in ");
                }
            });


            async function fillActiveBets() {
                document.getElementById("seeBets").style.display = "none";
                let user = firebase.auth().currentUser;
                console.log(user.uid);
                let length;
                let betsCount;
                let userMoney;
                if(user){
                    var docRef = db.collection("users").doc(user.uid);
                    length = await docRef.get().then(function (doc) {
                        if(doc.exists) {
                            betsCount = doc.data().numberOfBets;
                            userMoney = doc.data().money;
                            //console.log(doc.data());
                            return doc.data().counter;
                        }
                    });
                    console.log(betsCount);
                    if (betsCount === 0) {
                        document.getElementById("noBets").classList.remove("hidden");
                    }
                    document.getElementById("moneyAmount2").innerHTML += userMoney;
                    for (let i = 0; i < length; i++) {
                        docRef = db.collection("users").doc(user.uid).collection("activeBets").doc(user.uid+i);
                        docRef.get().then(function (doc) {
                            if(doc.exists) {
                                var id = doc.data().id;
                                var gameName = doc.data().game;
                                var date = doc.data().date;
                                var teamBetOn = doc.data().betOnHome;
                                var moneyBet = 0;
                                var odds = 0;
                                if(teamBetOn) {
                                    moneyBet = doc.data().homeBet;
                                    odds = doc.data().homeOdds;
                                } else {
                                    moneyBet = doc.data().awayBet;
                                    odds = doc.data().awayOdds;
                                }

                                console.log(id);
                                console.log(gameName);
                                console.log(date);
                                console.log(teamBetOn);
                                console.log(moneyBet);
                                console.log(odds);
                                let clone = document.getElementById("gameCard").cloneNode(true);
                                clone.classList.remove("hidden");
                                //let id = (gameOdds[i].Home + "|" + gameOdds[i].Away).replace(/ /g, "_");
                                console.log(id);
                                clone.id = id;
                                // let homeClass = gameOdds[i].Home.replace(/ /g, "-");
                                // let awayClass = gameOdds[i].Away.replace(/ /g, "-");
                                // clone.classList.add(homeClass);
                                // clone.classList.add(awayClass);
                                let names = clone.querySelector("#teamNames");
                                let homeTeam = gameName.split("|")[0].replace(/_/g, " ");
                                let awayTeam = gameName.split("|")[1].replace(/_/g, " ");
                                console.log(homeTeam);
                                names.innerHTML = homeTeam + " vs " + awayTeam;
                                let oddsHtml = clone.querySelector("#OddsBetOn");
                                oddsHtml.innerHTML += odds.toString().substring(0, 5) + "\n";
                                let teamBet = clone.querySelector("#teamBetOn");
                                if (teamBetOn) {
                                    teamBet.innerHTML += homeTeam;
                                } else {
                                    teamBet.innerHTML += awayTeam;
                                }

                                let profitWin = clone.querySelector("#ProfitIfWin");
                                profitWin.innerHTML += ((moneyBet * odds)-moneyBet).toString().substring(0, 5);
                                let dateGame = clone.querySelector("#gameDate");
                                dateGame.innerHTML = date;
                                // let gameDate = clone.querySelector("#gameDate");
                                // gameDate.innerHTML = gameOdds[i].date;
                                // clone.style.display = "flex";
                                // // clone.querySelector(".selectTeam").options[1].innerHTML = gameOdds[i]["Home"];
                                // // clone.querySelector(".selectTeam").options[2].innerHTML = gameOdds[i]["Away"];
                                clone.querySelector(".changeBet").addEventListener("click", function () {
                                    let amount = event.target.parentElement.parentElement.querySelector(".changeBetAmount").value;
                                    console.log(amount);
                                    if (!isNaN(amount) && amount > 0 && amount !== '') {
                                        // if (amount > 0.5 * moneyBet) {
                                        //     amount = 0.5 * moneyBet;
                                        // }
                                        changeBet(amount, id);
                                    }
                                    
                                });

                                clone.querySelector(".deleteBet").addEventListener("click", function () {
                                    deleteBet(id);
                                });

                                document.getElementById("cardHolder").appendChild(clone);
                            }
                        });

                    }

                }
            }
            async function changeBet(amount, id) {
                let user = firebase.auth().currentUser;
                if(user) {
                var docRef = db.collection("users").doc(user.uid);
                var homeBet;
                var previousBet = await db.collection("users").doc(user.uid).collection("activeBets").doc(id).get().then(function (doc) {
                    if (doc.exists) {
                    homeBet = doc.data().betOnHome;
                        if(doc.data().betOnHome) {
                            return doc.data().homeBet;
                        } else {
                            return doc.data().awayBet;
                        }
                    }
                });
                // .collection("bets").doc("active bets");
                docRef.get().then(function (doc) {
                    var filename = 0;
                    console.log(amount);
                    console.log(previousBet);
                    if (doc.exists) {
                    finalAmount = parseInt(doc.data().money) - parseInt(amount) + parseInt(previousBet);
                    if(finalAmount >= 0) {
                        if(amount > 2*previousBet) {
                        throw "amount is more than twice the previous bet";
                        } else if(amount <= previousBet) {
                        throw "amount is less than or equal to the previous bet";
                        }
                        console.log(amount);
                        db.collection("users").doc(user.uid).update({ money: finalAmount });
                        console.log(finalAmount);
                        if(homeBet) {
                        db.collection("users").doc(user.uid).collection("activeBets").doc(id).update({ homeBet: amount });
                        } else {
                        db.collection("users").doc(user.uid).collection("activeBets").doc(id).update({ awayBet: amount });
                        }
                    } else {
                        throw "The amount in your account is not sufficient for this transaction";
                    }
                    } else {
                    throw "bet cannot be placed since user doesn't exist";
                    }

                    if(homeBet) {
                        db.collection("bets").doc(id).update({ homeBet: amount });
                    } else {
                        db.collection("bets").doc(id).update({ awayBet: amount});
                    }

                    })
                    .catch(function(error) {
                        alert(error);
                    });
                }
            }

            function deleteBet(id) {
                let user = firebase.auth().currentUser;
                    if(user) {
                        var docRef = db.collection("users").doc(user.uid);
                        var homeBet;
                        db.collection("users").doc(user.uid).collection("activeBets").doc(id).delete().then(function() {
                            console.log("Document successfully deleted!");
                        }).catch(function(error) {
                            console.error("Error removing document: ", error);
                        });
                        db.collection("bets").doc(id).delete().then(function() {
                            console.log("Document successfully deleted!");
                        }).catch(function(error) {
                            console.error("Error removing document: ", error);
                        });
                        db.collection("users").doc(user.uid).update({numberOfBets: firebase.firestore.FieldValue.increment(-1)});
                    }
            }
            function getDate(UNIX_timestamp) {
                var a = new Date(UNIX_timestamp * 1000);
                var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                var year = a.getFullYear();
                var month = months[a.getMonth()];
                var date = a.getDate();
                var hour = a.getHours();
                var min = a.getMinutes();
                var sec = a.getSeconds();
                var time = date + ' ' + month + ' ' + year + ' ' + hour + ':' + min + ':' + sec;
                return time;
            }
            function avgOdds(sites, home) {
                let firstOdd = 0;
                let secondOdd = 0;
                for (let i = 0; i < sites.length; i++) {
                    firstOdd += sites[i].odds.h2h[0];
                    secondOdd += sites[i].odds.h2h[1];
                }
                if (home === 0) {
                    return [firstOdd / sites.length, secondOdd / sites.length];
                }
                return [secondOdd / sites.length, firstOdd / sites.length];
    
            }
            // printOdds();
            //fillActiveBets();
            function buttonEvent(amount, gameObj, homeBool) {
                console.log(amount);
                console.log(gameObj);
                console.log(homeBool);
            }
            
        </script>
        <!-- <script type="module" src="script.js"></script> -->
    </body>
    
    
    
</html>